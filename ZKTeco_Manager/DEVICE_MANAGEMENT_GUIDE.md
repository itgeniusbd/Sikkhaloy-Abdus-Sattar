# ?? ZKTeco Device Management & Sync Guide

## ?????? ?: ??? ???????????? ??? ?????? ?????????? ????? ???????

### ? ??????: Device Table ? School Mapping

????? database ? `Device` ????? ??? ?????? ??????? device ??? school ?? ???? map ??? ????:

```sql
Device Table:
??? DeviceID (PK)
??? DeviceSerial  ? Device ?? Unique Serial Number
??? DeviceName
??? DeviceIP
??? Port
??? SchoolID      ? ?? device ??? school ??
??? DeviceStatus
```

### ?????? ??? ???:

```
1. Device Push ??? ? DeviceSerial ??????
2. API Query ???:
   SELECT SchoolID FROM Device WHERE DeviceSerial = 'DEVICE123'
3. SchoolID ????? ????
4. ? School ?? ???? process ???
```

---

## ?????? ?: ????????? ???? ???? ????? ??????? ?????? ???????

### ? ??????: Device Management API + Sync Tool

??? ????? ????? ???? ?????:

### 1. Device Management API (ZKTeco.PushAPI)

???? Controller ????? ??????: **`DeviceManagementController.cs`**

#### Available Endpoints:

| Endpoint | Method | ??? |
|----------|--------|-----|
| `/api/device/school/{schoolId}` | GET | School ?? ?? device ???? |
| `/api/device/serial/{serial}` | GET | Device info by serial |
| `/api/device/register` | POST | ???? device register |
| `/api/device/{deviceId}/users` | GET | Device ?? ???? user list |
| `/api/device/{deviceId}/fingerprints` | GET | Device ?? ???? fingerprint list |
| `/api/device/sync/{deviceId}` | POST | Sync time update |

### 2. Device Sync Tool (???? Console Application)

**Location:** `ZKTeco_Manager/ZKTeco.DeviceSync/`

??? AttendanceDevice ???????????? ???? ??? ???:
- ? API ???? user list ????
- ? API ???? fingerprint ????
- ? ZKTeco SDK ????? device ? push ???
- ? Sync time update ???

---

## ?? Setup Instructions

### Step 1: Device Table Setup

????? database ? device register ????:

```sql
-- Device register ????
INSERT INTO Device (DeviceSerial, DeviceName, DeviceIP, Port, SchoolID, DeviceStatus)
VALUES 
('BBKB193260050', 'Main Gate Device', '192.168.0.201', 4370, 1, 'Active'),
('BBKB193260051', 'Back Gate Device', '192.168.0.202', 4370, 1, 'Active')

-- Check ????
SELECT * FROM Device
```

**DeviceSerial ?????? ?????:**
1. ZKTeco device ?? admin menu ?????
2. System Info ? Device Info
3. Serial Number copy ????

### Step 2: API Deploy ????

```powershell
# Deploy ???? (???? ????)
cd F:\SIKKHALOY-V3\ZKTeco_Manager
.\Deploy-PushAPI.ps1
```

### Step 3: API Test ????

```powershell
# Device info get ????
Invoke-RestMethod "http://localhost:8080/api/device/school/1"

# Users list get ???? (Device ID = 1 ?? ????)
Invoke-RestMethod "http://localhost:8080/api/device/1/users"

# Fingerprints list get ????
Invoke-RestMethod "http://localhost:8080/api/device/1/fingerprints"
```

### Step 4: Device Sync Tool Build ????

```powershell
# Build ????
cd F:\SIKKHALOY-V3\ZKTeco_Manager\ZKTeco.DeviceSync
dotnet build

# ???? Visual Studio ? open ??? build ????
```

### Step 5: Sync Tool Configure ????

`App.config` edit ????:

```xml
<appSettings>
  <add key="ApiBaseUrl" value="http://YOUR_SERVER_IP:8080/" />
</appSettings>
```

### Step 6: Device ? Data Push ????

```powershell
# Sync tool ?????
cd F:\SIKKHALOY-V3\ZKTeco_Manager\ZKTeco.DeviceSync\bin\Debug
.\ZKTeco.DeviceSync.exe

# Enter Device ID: 1
```

**Output:**
```
?????????????????????????????????????????????????????
?   ZKTeco Device Synchronization Tool            ?
?????????????????????????????????????????????????????

Enter Device ID: 1

Fetching device information from server...
Device: Main Gate Device
School: ABC School
IP: 192.168.0.201:4370

Connecting to device...
? Connected to device successfully!

Fetching users from server...
Found 150 users
  Students: 120
  Employees: 30

Syncing users to device...
? Synced: 150/150

User sync completed!
  Success: 150
  Failed: 0

Fetching fingerprints from server...
Found 300 fingerprint templates

Syncing fingerprints to device...
? Synced: 300/300

Fingerprint sync completed!
  Success: 300
  Failed: 0

?????????????????????????????????????????????????????
?   Synchronization Completed Successfully!       ?
?????????????????????????????????????????????????????
```

---

## ?? Data Flow Diagram

### AttendanceDevice ?? ?????:

#### ??? (AttendanceDevice):
```
AttendanceDevice Software
    ?
SQLite Local Database ???? data ????
    ?
ZKTeco SDK ????? Device ? push ???
```

#### ??? (New System):
```
ZKTeco.DeviceSync Tool
    ?
PushAPI ???? data ???? (API call)
    ? (GET /api/device/{id}/users)
    ? (GET /api/device/{id}/fingerprints)
PushAPI Database ???? ??????
    ?
ZKTeco SDK ????? Device ? push ???
```

### ??????:
1. ? Centralized - ?? data ?? ????????
2. ? Remote Access - ????? ?????? ???? sync ??? ????
3. ? Real-time - ?????? latest data
4. ? Multiple Device - ?????? ???? device manage ??? ????

---

## ?? Device Management Workflow

### 1. ???? Device Add ???:

```powershell
# API call ????
$body = @{
    DeviceSerial = "BBKB193260050"
    DeviceName = "Main Gate"
    DeviceIP = "192.168.0.201"
    Port = 4370
    SchoolID = 1
    CommKey = 0
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8080/api/device/register" `
                  -Method POST `
                  -Body $body `
                  -ContentType "application/json"
```

### 2. Device ? User Sync ???:

**Option A: Sync Tool ??????? ????** (Recommended)
```powershell
.\ZKTeco.DeviceSync.exe
# Device ID enter ????
```

**Option B: Manually API ???? data ????? push ????**
```csharp
// ????? ????? application ? ?? code ??????? ???? ?????
var users = GetUsersFromAPI(deviceId);
foreach(var user in users)
{
    zkDevice.SSR_SetUserInfo(1, user.UserDeviceID.ToString(), user.UserName, "", 0, true);
}
```

### 3. Device ???? Attendance ??????:

??? automatic - Device ????? push ???!
```
Device ? Push Protocol ? PushAPI ? Database
```

---

## ?? Complete Setup Checklist

### Database Setup:
- [ ] Device table ? device information ???
- [ ] Student table ? DeviceID set ??? ???
- [ ] Employee table ? DeviceID set ??? ???
- [ ] User_FingerPrint table ? fingerprint data ???

### API Setup:
- [ ] PushAPI deploy ??? ??????
- [ ] Web.config ? connection string ????
- [ ] Device Management API test ??? ??????

### Device Setup:
- [ ] Device network ? connected
- [ ] Device IP & Port ????
- [ ] Device Push URL configure ???
- [ ] Device Serial Number database ? match ???

### Sync Tool Setup:
- [ ] DeviceSync tool build ??? ??????
- [ ] App.config ? API URL ????
- [ ] ZKTeco SDK dll ???
- [ ] Sync test ??? ??????

---

## ?? Testing

### Test 1: API ???? Users ??????
```powershell
# PowerShell test
$response = Invoke-RestMethod "http://localhost:8080/api/device/1/users"
Write-Host "Total Users: $($response.TotalUsers)"
Write-Host "Students: $($response.Students)"
Write-Host "Employees: $($response.Employees)"
```

### Test 2: Device Connection
```csharp
CZKEM zkDevice = new CZKEM();
if(zkDevice.Connect_Net("192.168.0.201", 4370))
{
    Console.WriteLine("Connected!");
    zkDevice.Disconnect();
}
```

### Test 3: User Sync
```powershell
# Sync tool ????? ??? check ???? device ? user ???? ????
.\ZKTeco.DeviceSync.exe
```

---

## ?? Common Issues

### Issue 1: Device Serial ?????? ??

**Solution:**
```
1. Device admin menu ? System ? Device Info
2. Serial Number ?????
3. Database ? exact same serial ??? (case-sensitive)
```

### Issue 2: API ???? users ?????? ??

**Solution:**
```sql
-- Check ???? users ?? DeviceID set ??? ????
SELECT COUNT(*) FROM Student WHERE DeviceID IS NOT NULL AND SchoolID = 1
SELECT COUNT(*) FROM Employee WHERE DeviceID IS NOT NULL AND SchoolID = 1

-- ??? ?? ????, set ????:
UPDATE Student SET DeviceID = 1 WHERE StudentID = 123 AND SchoolID = 1
```

### Issue 3: Device connect ????? ??

**Solution:**
```powershell
# Network test ????
ping 192.168.0.201

# Port test ????
Test-NetConnection -ComputerName 192.168.0.201 -Port 4370
```

---

## ?? API Documentation

### Get School Devices
```http
GET /api/device/school/{schoolId}

Response:
[
  {
    "DeviceID": 1,
    "DeviceSerial": "BBKB193260050",
    "DeviceName": "Main Gate",
    "DeviceIP": "192.168.0.201",
    "Port": 4370,
    "SchoolID": 1,
    "DeviceStatus": "Active",
    "LastSyncTime": "2024-12-10T10:30:00"
  }
]
```

### Get Device Users
```http
GET /api/device/{deviceId}/users

Response:
{
  "TotalUsers": 150,
  "Students": 120,
  "Employees": 30,
  "Users": [
    {
      "UserDeviceID": 1,
      "UserName": "?????? ????",
      "UserCode": "STU001",
      "UserType": "Student",
      "Status": "Active"
    }
  ]
}
```

### Get Device Fingerprints
```http
GET /api/device/{deviceId}/fingerprints

Response:
{
  "TotalFingerprints": 300,
  "Fingerprints": [
    {
      "UserDeviceID": 1,
      "FingerIndex": 0,
      "TemplateData": "Base64EncodedTemplate...",
      "Flag": 1,
      "UserType": "Student"
    }
  ]
}
```

---

## ?? Summary

### ??? (AttendanceDevice):
- ? Local SQLite database
- ? Local application required
- ? Separate sync process

### ??? (New System):
- ? Centralized SQL Server
- ? API-based data retrieval
- ? Separate sync tool (optional)
- ? Real-time push from device
- ? Remote management

### ???? System ??????:
1. **Device ? Server (Push)** - Automatic attendance receive
2. **Server ? Device (Sync)** - Manual user/fingerprint sync

---

**??? ???? AttendanceDevice ?? ???? ???? device ? push ???? ??????! ??**

?? ??? ?????? ????? ???????! ??
