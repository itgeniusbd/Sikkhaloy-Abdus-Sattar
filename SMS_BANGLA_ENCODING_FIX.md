# SMS Bangla Character Encoding Fix ????

## ? ?????? ??????? ??? ??????
**??????**: SMS ?????? ????? text ?? ???????? **"?????"** (question marks) ??????????

**????**: 
- `Uri.EscapeDataString()` ????????? ASCII characters handle ???
- ????? (Unicode) characters ?? ???? **UTF-8 encoding** ????????
- SMS Gateway ? data ??????? ???? proper encoding ?????? ??

---

## ?? ?????? Implementation

### **1. Custom URL Encoding Method ????**
???? custom `UrlEncodeBangla()` method ???? ??? ?????? ??:
- UTF-8 byte array ?? convert ???
- ??????? byte ?? percent-encoding ? convert ???
- ASCII characters safe ????
- Space ?? '+' ?? convert ???
- ????? characters ???????? encode ???

```csharp
private static string UrlEncodeBangla(string text)
{
    if (string.IsNullOrEmpty(text))
        return text;

    var bytes = Encoding.UTF8.GetBytes(text);
    var sb = new StringBuilder();

    foreach (var b in bytes)
    {
        // Only encode non-ASCII characters and special characters
        if ((b >= 'a' && b <= 'z') || (b >= 'A' && b <= 'Z') || (b >= '0' && b <= '9') ||
            b == '-' || b == '_' || b == '.' || b == '~')
        {
            sb.Append((char)b);
        }
        else if (b == ' ')
        {
            sb.Append('+');
        }
        else
        {
            sb.Append('%');
            sb.Append(b.ToString("X2"));
        }
    }

    return sb.ToString();
}
```

---

### **2. SMS Provider Files Updated**

#### ? **SmsProviderBanglaPhone.cs**
- `SendSms()` method ? `UrlEncodeBangla()` ???????
- Content-Type ? `charset=utf-8` ??? ???
- Data encoding `UTF-8` ?? ????????

#### ? **SmsProviderGreenWeb.cs**
- `SendSms()` method ? `UrlEncodeBangla()` ???????
- `SendSmsMultiple()` method ?? same fix
- Content-Type ? `charset=utf-8` ??? ???

---

## ?? Updated Code Details

### Before (? ??????):
```csharp
// Using Uri.EscapeDataString() - Only handles ASCII
var smsText = Uri.EscapeDataString(safeMassage);
var data = Encoding.ASCII.GetBytes(urlEncodedData);
request.ContentType = "application/x-www-form-urlencoded";
```

**Result**: 
```
Dear, ??? ?????? ???????? ??? ????. ????? ?????? ??????: 9000 ????
```

### After (? ??????):
```csharp
// Using custom UrlEncodeBangla() - Handles UTF-8/Bangla
var smsText = UrlEncodeBangla(safeMassage);
var data = Encoding.UTF8.GetBytes(urlEncodedData);
request.ContentType = "application/x-www-form-urlencoded; charset=utf-8";
```

**Result**:
```
Dear, ??? ?????? ???????? ??? ????. ????? ?????? ??????: 9000 ????
```

---

## ?? ???? ???????? Fix ??? ??????

### **File 1: SmsProviderBanglaPhone.cs**
| Method | Change | Status |
|--------|--------|--------|
| `SendSms()` | UrlEncodeBangla() + UTF-8 encoding | ? Fixed |
| Content-Type | Added charset=utf-8 | ? Fixed |

### **File 2: SmsProviderGreenWeb.cs**
| Method | Change | Status |
|--------|--------|--------|
| `SendSms()` | UrlEncodeBangla() + UTF-8 encoding | ? Fixed |
| `SendSmsMultiple()` | UrlEncodeBangla() + UTF-8 encoding | ? Fixed |
| Content-Type | Added charset=utf-8 | ? Fixed |
| `UrlEncodeBangla()` | New helper method | ? Added |

---

## ?? Testing Steps

### **?????? 1: Donor Present Due ???? SMS ?????**
1. `Committee/Donor_Present_Due.aspx` ???? ???
2. ???? Donor ??????? ????
3. "Send SMS" ????? ????? ????
4. ??????? SMS ??? ????

### **Expected Result**:
```
Dear, ?????? ???????. ????? ?????? ??????: 9000 ????. 
?????????: ????? ?????: June 2025 - 1000 Tk, ????? ?????: July 2025 - 1000 Tk
???????, ??????? ???????? ?????? ?????
```

### **?????? 2: Manual SMS Test**
1. `SMS/Send_SMS.aspx` ???? ???
2. Single SMS ???? ??????? ????
3. ????? text ????? SMS ?????:
   ```
   ???????: ???? ??? ?????? ???????? ????????
   ```
4. ??????? proper ????? text ???? ????

---

## ?? Technical Details

### **UTF-8 Encoding Process**:
1. **Input**: "?????" (Bangla text)
2. **UTF-8 Bytes**: `E0 A6 86 E0 A6 AA E0 A6 A8 E0 A6 BE E0 A6 B0`
3. **Percent Encoding**: `%E0%A6%86%E0%A6%AA%E0%A6%A8%E0%A6%BE%E0%A6%B0`
4. **SMS Gateway**: Properly decodes UTF-8 bytes
5. **Mobile Phone**: Displays "?????" correctly

### **Why This Works**:
- SMS ??????? UTF-8 bytes ????? ????
- Percent-encoding (%XX format) standard web encoding
- Mobile networks automatically decode UTF-8
- No data loss during transmission

---

## ?? Character Support

| Character Type | Before | After |
|---------------|--------|-------|
| English (A-Z) | ? Works | ? Works |
| Numbers (0-9) | ? Works | ? Works |
| Bangla (?-?) | ? Shows ???? | ? Works |
| Bangla (?-?) | ? Shows ???? | ? Works |
| Symbols (.,!?) | ? Works | ? Works |
| Special (+) | ?? Replaced | ? "Plus" |

---

## ?? Important Notes

### **1. System.Web Dependency**
- ???? `System.Web.HttpUtility.UrlEncode()` ??????? ???? ??????????
- ?????? Solution ???? ?????? .csproj edit ??? ??????
- ??? custom `UrlEncodeBangla()` method ???? ??? ??????
- ??? ??? ???? ???? external dependency ???

### **2. '+' Symbol Handling**
- A+ Grade ?? "A Plus" ? convert ??? ???
- ???? '+' URL encoding ? space ?????? ??????? ???
- ??? SMS Gateway ?? requirement

### **3. Content-Type Header**
- `charset=utf-8` ??? ??? ??????? ????????????
- ??? SMS Gateway ?? ??? ?? data UTF-8 encoded
- Without this, gateway ASCII ?????? treat ????

---

## ?? Build Status
**? Build Successful!**

All changes compiled successfully without errors.

---

## ?? Updated Files Summary

| File Path | Lines Changed | Status |
|-----------|--------------|--------|
| `SmsService\Providers\SmsProviderBanglaPhone.cs` | ~60 lines | ? Updated |
| `SmsService\Providers\SmsProviderGreenWeb.cs` | ~80 lines | ? Updated |

---

## ? Benefits

1. ? **????? SMS ???????? ?????? ????**
2. ? **??? Character Loss ???**
3. ? **Standard UTF-8 Encoding**
4. ? **?? SMS Provider ? ??? ????**
5. ? **No External Dependencies**
6. ? **Mobile ? Properly Display ???**

---

## ?? ?????? ?????? ??????!

??? ????:
- ????? Due SMS ???????? ??????? ????
- Student Present Due SMS
- Attendance SMS
- Payment SMS
- ?? ????? ????? SMS properly display ???

**??? ????? SMS System ???????????? ????? Support ???!** ??????
